name: Database Backup

on:
    schedule:
        - cron: "0 2 * * *" # Daily at 2 AM UTC
    workflow_dispatch: # Manual trigger

jobs:
    backup:
        name: Backup Database
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup SSH
              env:
                  SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
                  SSH_HOST: ${{ secrets.DEPLOY_HOST }}
                  SSH_USER: ${{ secrets.DEPLOY_USER }}
              run: |
                  mkdir -p ~/.ssh
                  echo "$SSH_KEY" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

            - name: Create database backup
              env:
                  SSH_HOST: ${{ secrets.DEPLOY_HOST }}
                  SSH_USER: ${{ secrets.DEPLOY_USER }}
                  DB_NAME: ${{ secrets.DB_NAME }}
              run: |
                  BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILE="backup_${DB_NAME}_${BACKUP_DATE}.sql.gz"
                  ssh $SSH_USER@$SSH_HOST "docker-compose exec -T mysql mysqldump -u root -p\$MYSQL_ROOT_PASSWORD $DB_NAME | gzip > /backups/$BACKUP_FILE"
                  echo "✅ Backup created: $BACKUP_FILE"

            - name: Cleanup old backups
              env:
                  SSH_HOST: ${{ secrets.DEPLOY_HOST }}
                  SSH_USER: ${{ secrets.DEPLOY_USER }}
              run: |
                  ssh $SSH_USER@$SSH_HOST "find /backups -name 'backup_*.sql.gz' -mtime +30 -delete"
                  echo "✅ Old backups cleaned up"

            - name: Notify backup status
              if: failure()
              run: echo "❌ Database backup failed!"
